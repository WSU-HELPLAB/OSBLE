@using OSBLE.Controllers;
@using OSBLE.Models.Assignments;
@using OSBLE.Models.Assignments.Activities;
@using OSBLE.Models.Assignments.Activities.Scores;
@using OSBLE.Models.Courses;
@{
    Layout = null;
    var index = 0;
}

@{
        var numDropped = (from drop in ViewBag.Dropped as IEnumerable<int> select drop).First();
        <input type="hidden" id="numDropped" value="@numDropped" />
        var customize_option = (from co in ViewBag.Customize as IEnumerable<Category.GradeOptions> select co).FirstOrDefault();
        <input type="hidden" id="customize_option" value="@customize_option" />
    }

<table id="grades" class="gradebook">



    <tr class="colHeader">
            
        @{var j = 1;
            <td id="_row-@index" class="rowHeader" style="background:#DCDCDC; border:outset 2.5px; border-color: #E8E8E8; width: 25px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectRow(event, this);"></td>
            index++;
            j += 1;
            <td id="@j" class="colHeader" style="background:#DCDCDC; border:outset 2.5px; border-color:#E8E8E8" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectColumn(event, this);"></td>
            j += 1;
            <td id="@j" class="colHeader" style="background:#DCDCDC; border:outset 2.5px; border-color:#E8E8E8" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectColumn(event, this);"></td>
            j += 1;
            foreach (AbstractAssignmentActivity item in ViewBag.GradeAssignments)
            {
                <td id="@j" class="colHeader" style="background:#DCDCDC; border:outset 2px; border-color:#E8E8E8; text-align:center; min-width: 45px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectColumn(event, this);">  
                <div id="div-@j" style="display: none; margin:0 auto;">
                    <img id="imgLeft-@item.ID" src="/Content/images/arrow_left.png" onclick="moveLeft(this);" style="cursor:pointer; float:left; padding-top:1px;"/>
                    <img id="imgDown-@item.ID" src="/Content/images/arrow_down.png" onclick="ShowHide(event, this);" style="cursor:pointer; padding-bottom:2px;"/>
                    <img id="imgRight-@item.ID" src="/Content/images/arrow_right.png" onclick="moveRight(this);" style="cursor:pointer; float:right;" />
                </div>
                </td>
                j += 1;
            }
        }
            
    </tr>

    <tr id="perfectScore">
        <td id="_row-@index" class="rowHeader" style="background:#DCDCDC; border:outset 2px; border-color:#E8E8E8" width: 25px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectRow(event, this);"></td>
        @{index++;}
        <td id="th2"><b>Perfect Score</b></td>
        <td id="perfectTotal">100%</td>
        @foreach (AbstractAssignmentActivity item in ViewBag.GradeAssignments)
        {
            <td id="pointsPossible-@item.ID" onclick="cellGainsFocus(event, this)">@item.PointsPossible</td>
        }
        
    </tr>
    <tr id="averageRow">
        <td id="_row-@index" class="rowHeader" style="background:#DCDCDC; border:outset 2px; border-color:#E8E8E8" width: 25px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectRow(event, this);"></td>
        @{index++;}
        <td id="th3">
            <b>Average Score</b>
        </td>
        <td id="averageTotal">
            0
        </td>
        @foreach (AbstractAssignmentActivity item in ViewBag.GradeAssignments)
        {
            <td id="averageScore" >0</td>  
        }
    </tr>
    
    <tr>
    <td id="_row-@index" class="rowHeader" style="background:#DCDCDC; border:outset 2px; border-color:#E8E8E8" width: 25px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectRow(event, this);"></td>
    @{index++;}
    @{
    
        <th id="th4" >
            Name
        </th>
        
        if (customize_option == Category.GradeOptions.XtoDrop && numDropped != 0)
        {
                <th id="totalCustomize">Total <input id="dropLowestButton" type="button" onclick="displayCustomizeGrades();" value="Average [Drop @numDropped lowest]" /> </th>
        }
        else if (customize_option == Category.GradeOptions.XtoTake && numDropped != 0)
        {
            <th id="totalCustomize">Total <input id="dropLowestButton" type="button" onclick="displayCustomizeGrades();" value="Average [Keep @numDropped highest]" /> </th>
        }
        else
        {
            <th id="totalCustomize">Total <input id="dropLowestButton" type="button" onclick="displayCustomizeGrades();" value="Average" /></th>
        }

        int i = 2;
        foreach (AbstractAssignmentActivity assign in ViewBag.GradeAssignments)
        {

            if (assign.addedPoints > 0)
            {   
                    <th id="header-@assign.ID" onclick="changeHeaderName(event, this)">@assign.Name (Added @assign.addedPoints)</th>
            }
            else
            {
                    <th id="header-@assign.ID" onclick="changeHeaderName(event, this)">@assign.Name </th>
            }
            i += 1;
        }
        }
            
    </tr>
    <!--loop through all users -->
    @foreach (OSBLE.Models.Users.UserProfile user in ViewBag.Users)
    {        
        <tr id="studentGrades">
            <td id="_row-@index" class="rowHeader" style="background:#DCDCDC; border:outset 2px; border-color:#E8E8E8; width:25px;" onmouseover="showButton(this);" onmouseout="hideButton(this);" onclick="selectRow(event, this);"></td>
            @{index++;}
            <td id="@user.Identification" >@user.LastName, @user.FirstName</td>
                    
            @{
              var percent = from p in ViewBag.Percents as IEnumerable<Score>
                            where p.TeamUserMember.Contains(user)
                            select p;
              if (percent.Count() > 0)
              {
                  if (percent.First().Points > 0)
                  {
                      <td id="total">@percent.First().Points.ToString(".##")%</td>
                  }
                  else
                  {
                      <td id="total">@String.Format("{0}", 0)%</td>
                  }
              }
              else
              {
                    <td id="total">@String.Format("{0}", 0)</td>
              }
            }

                
            @foreach (AbstractAssignmentActivity gradeAssignmentActivity in ViewBag.GradeAssignments)
            {

                var gradableQuery = from g in ViewBag.Grades as IEnumerable<Score>
                                    where g.AssignmentActivityID == gradeAssignmentActivity.ID
                                    && g.TeamUserMember.Contains(user)
                                    && g.Points >= 0
                                    select g;
                //use the stored score if possible.  Otherwise, just use a "0"
                if (gradableQuery.Count() > 0)
                {
                    <td id="@String.Format("{0}-{1}", user.Identification, gradeAssignmentActivity.ID)" onclick="cellGainsFocus(event, this)">@gradableQuery.First().Points</td>
                }
                else
                {
                    //Razor didn't like me using just a "0" so I had to wrap it inside String.Format
                    <td id="@String.Format("{0}-{1}", user.Identification, gradeAssignmentActivity.ID)" onclick="cellGainsFocus(event, this)">NG</td>
                }
            }
        </tr>
    }
    <script type="text/javascript">
        $(function () {
//            alert($('#customize_option').val());
//            alert($('#numDropped').val());
//            if ($('#customize_option').val() == "CompAverage" || $('#numDropped').val() == 0) {
//                $('#CompAverage_radio').attr('checked', true);
//            }
//            else if ($('#customize_option') == "XtoDrop") {
//                $('#XtoDrop_radio').attr('checked', true);
//                $('#XtoDrop').val(numDropped);
//            }
//            else if ($('#customize_option') == "XtoTake") {
//                $('#XtoTake_radio').attr('checked', true);
//                $('#XtoTake').val(numDropped);
//            }

            calculateCols();
            keyControls();
        });

    </script>
</table>

