@using OSBLE.Controllers;
@using OSBLE.Models.Assignments;
@using OSBLE.Models.Assignments.Activities;
@using OSBLE.Models.Assignments.Activities.Scores;
@{
    Layout = null;
}

<table id="grades" class="gradebook">

    <tr class="colHeader">
            
        @{var j = 1;
            <td id="@j" class="colHeader" style="background:silver; border:outset 3px;" onclick="selectColumn(this);" onmouseover="showButton(this);" onmouseout="hideButton(this);"></td>
            j += 1;
            <td id="@j" class="colHeader" style="background:silver; border:outset 3px;" onclick="selectColumn(this);" onmouseover="showButton(this);" onmouseout="hideButton(this);"></td>
            j += 1;
            foreach (AbstractAssignment item in ViewBag.Assignments)
            {
                <td id="@j" class="colHeader" style="background:silver; border:outset 3px; text-align:right;"onclick="selectColumn(this);" onmouseover="showButton(this);" onmouseout="hideButton(this);">
                <div id="div-@j" style="display: none;" onmouseover="showButton(this);" onmouseout="hideButton(this);">
                <!--Makes the columns with color change options distinguishable-->
                    <img src="/Content/images/arrow_down.png" onmouseover="changeCursor()" style="cursor:pointer;"/>
                </div>
                </td>
                j += 1;
            }
        }
            
    </tr>

    <tr id="perfectScore">
        <th id="th2">Perfect Score</th>
        <td id="perfectTotal">100%</td>
        @foreach (AbstractAssignment item in ViewBag.Assignments)
        {
            <td id="pointsPossible-@item.ID" onclick="cellGainsFocus(this)">@item.PointsPossible</td>
        }
        
    </tr>
    <tr id="averageRow">
        <th id="th3">
            Average Score
        </th>
        <td id="averageTotal">
            0
        </td>
        @foreach (AbstractAssignment item in ViewBag.Assignments)
        {
            <td id="averageScore" >0</td>  
        }
    </tr>
    
    <tr>
    @{
        var numDropped = (from drop in ViewBag.Dropped as IEnumerable<int> select drop).FirstOrDefault();     
        
        <input type="hidden" id="numDropped" value="@numDropped" />
    
        <th id="th4" ondblclick="clearDropLowest()">
            Name
        </th>
        
            if( numDropped == 0)
            {
                <th id="totalCustomize">Total <input id="dropLowestButton" type="button" onclick="displayCustomizeGrades();" value="Average" /></th>
            }
            else
            {
                <th id="totalCustomize">Total <input id="dropLowestButton" type="button" onclick="displayCustomizeGrades();" value="Average [Dropped @numDropped]" /> </th>
            }
        
            int i = 1;
            foreach (AbstractAssignment item in ViewBag.Assignments)
            {   
                <th id="header-@item.ID" onclick="changeHeaderName(this)">@item.Name<div id="cntnr" class="thButton"><button class="dropdown" id="@item.ID" onclick="ShowHide(this);"></button></div></th>
                i += 1;
            }
        }
            
    </tr>
    <!--loop through all users -->
    @foreach (OSBLE.Models.Users.UserProfile user in ViewBag.Users)
    {        
        <tr id="studentGrades">
            <td id="@user.ID" >@user.LastName, @user.FirstName</td>
                    
            @{
        var percent = from p in ViewBag.Percents as IEnumerable<Score>
                      where p.UserProfileID == user.ID
                      select p;
        if (percent.Count() > 0)
        {
                    <td id="total">@percent.First().Points.ToString(".##")%</td>
        }
        else
        {
                    <td id="total">@String.Format("{0}", 0)</td>
        }
            }

                
            @foreach (AbstractAssignment gradeAssignment in ViewBag.GradeAssignments)
            {

                var gradableQuery = from g in ViewBag.Grades as IEnumerable<Score>
                                    where g.AssignmentActivity.AbstractAssignmentID == gradeAssignment.ID
                                    && g.UserProfileID == user.ID
                                    && g.Points >= 0
                                    select g;
                //use the stored score if possible.  Otherwise, just use a "0"
                if (gradableQuery.Count() > 0)
                {
                            <td id="@String.Format("{0}-{1}", user.ID, gradeAssignment.ID)" onclick="cellGainsFocus(this)">@gradableQuery.First().Points</td>
                }
                else
                {
                    //Razor didn't like me using just a "0" so I had to wrap it inside String.Format
                            <td id="@String.Format("{0}-{1}", user.ID, gradeAssignment.ID)" onclick="cellGainsFocus(this)">NG</td>
                }
            }
        </tr>
    }
    <script type="text/javascript">
        //var lastFocusedCell = null;
        $(function () {
            calculateCols();
            keyControls();
        });

        function showButton(column) {
            var container = column.id;
            $("#div-" + container).animate({ "height": "show" }, { duration: 0 });
        }

        function hideButton(column) {
            var container = column.id;
            $("#div-" + container).animate({ "height": "hide" }, { duration: 0 });
        }
    </script>

</table>

