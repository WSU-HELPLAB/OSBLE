@model OSBLE.Models.Users.Mail
@using OSBLE.Models
@using OSBLE.Models.Users

@{
    ViewBag.Title = "Create";
    List<UserProfile> recipients = Session["mail_recipients"] as List<UserProfile>;
}

<h2>@ViewBag.MailHeader</h2>

<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>

@using (Html.BeginForm())
{
    @Html.ValidationSummary(true)

    <a>To:</a>
    if (ViewBag.MailHeader == "New Message")
    {
        <input id="people_finder" />
        @Helpers.CreateToolTip(ToolTips.MailRecipient) 
        <script type="text/javascript">

            $("#people_finder").autocomplete({
                source: "@(Url.Action("Search"))",
                select: function(event, ui) {
                    location.href="@Url.Action("Create")?recipientID=" + ui.item.value;
                },
                focus: function(event, ui) {return false;}
            }).data("autocomplete")._renderItem = function( ul, item ) {
                return $( "<li></li>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + "<img src=\"@Url.Action("ProfilePicture")/" + item.value + "\" class=\"small_profile_picture\" alt=\"Profile Picture\" /> " + item.label+ "</a>" )
                .appendTo( ul );
            }
        </script>
    }
    <br />

    if (recipients != null)
    {
        foreach (UserProfile up in recipients)
        {
            <div id="recipient + @up.ID" class="recipient">
                <div class="recipient_tools">
                    @if (ViewBag.MailHeader == "New Message")
                    {
                        <a id="@up.ID" href="#" title="Delete this recipient" onclick="removeRecipient(@up.ID);" ><img src="/Content/images/delete_up.png" alt="Delete Button" /></a>
                    }
                </div>
                @Helpers.ProfilePicture(@Url.Action("ProfilePicture", new { ID = up.ID }))

                <div class="editor-field">
                    @up.FirstName @up.LastName
                    @Html.HiddenFor(model => model.FromUserProfileID)
                    @Html.ValidationMessageFor(model => model.ToUserProfileID)
                </div>
            </div>
        }
    }
    //<br />
        <div class="editor-field" style="clear: both;">
            @Html.LabelFor(model => model.Subject): @Html.EditorFor(model => model.Subject)<br />
            @Html.ValidationMessageFor(model => model.Subject)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.Message)
        </div>
        <div class="editor-field">
            @Html.TextAreaFor(model => model.Message, new { @id = "send_mail_textarea" })<br />
            @Html.ValidationMessageFor(model => model.Message)
        </div>

        <p>
            <input type="submit" value="Send Message" />
        </p>
}

<div>
    @Html.ActionLink("Back to Inbox", "Index")
</div>

<script type="text/javascript">

    function removeRecipient(recip) {
        location.href="@Url.Action("Create")?recipientID=" + -recip;
    }

</script>
