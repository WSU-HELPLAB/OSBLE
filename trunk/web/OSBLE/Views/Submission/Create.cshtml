@model OSBLE.Models.AbstractCourses.Course.Submission
@using OSBLE.Models.Assignments.Activities;
@using OSBLE.Models;
@{
    ViewBag.Title = "Create";
}
<h2>
    Create</h2>
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script type="text/javascript">


    $(function () {

        $('#file_uploader_form').submit(function ValidateForm(event) {
            var file_uploaders = $("#file_uploader_form :input");
            var i = 0;
            for (i = 0; i <= file_uploaders.length; i++) {
                if (isValid(file_uploaders[i]) == false) {
                    if (!confirm('One or more deliverables does not have a file. Would you like to continue')) {
                        event.preventDefault();
                    }
                    break;
                }
            }

        });

    });
    function checkFileExension(elem, validExtensions) {
        var filePath = elem.value;
        var indexOfDot = filePath.indexOf('.');
        if (indexOfDot == -1) {
            elem.value = "";
            return false;
        }

        var ext = filePath.substring(filePath.lastIndexOf('.') + 1).toLowerCase();
        for (var i = 0; i < validExtensions.length; i++) {
            if (ext == validExtensions[i]) {
                return true;
            }
        }

        alert('The file extension ' + ext.toUpperCase() + ' is not allowed!');

        elem.value = "";

        return false;
    }

    function isValid(elem)
    {
        if (elem.value == null || elem.value.length == 0) {
                return false;
            }
            return true;
    }

</script>
@{
    int fileUploadsSoFar = 0;
}
@using (Html.BeginForm("Create", "Submission", FormMethod.Post, new { id = "file_uploader_form", enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true)
    <fieldset>
        <legend>Submission</legend>
        @foreach (Deliverable deliverable in ViewBag.Deliverables.Keys)
        {
            <table>
                <tr>
                    <td>
                        <b>Desired Name:</b>
                    </td>
                    <td>
                        @deliverable.Name
                    </td>
                </tr>
                <tr>
                    <td>
                        <b>File Type:</b>
                    </td>
                    <td>
                        @(((DeliverableType)deliverable.Type).ToString())
                    </td>
                </tr>
                <tr>
                    <td>
                        <b>Allowed File Extensions:</b>
                    </td>
                    <td>
                        @String.Join(" ", ViewBag.Deliverables[deliverable])
                    </td>
                </tr>
                <tr>
                    <td>
                        @{
            //write javascript code to create a new array call it stringArray{0} where {0} is the one we are on.
            //then push all the allowed extensions on it while removing the . from them
            string newString = "";
            newString = "var stringArray" + fileUploadsSoFar.ToString() + " = new Array();";
            foreach (string s in ViewBag.Deliverables[deliverable])
            {
                newString += "stringArray" + fileUploadsSoFar.ToString() + ".push(" + "\"" + s.Remove(0, 1) + "\");";
            }
                            
                            
                        }
                        <script type="text/javascript">
                    //we create our JavaScript string this is where it runs the code it just generated.
                        @MvcHtmlString.Create(newString);
                        </script>
                        <input type='file' name='files' onchange="checkFileExension(this, @MvcHtmlString.Create("stringArray" + fileUploadsSoFar.ToString()))"/>
                        @{
            fileUploadsSoFar++;
                        }
                    </td>
                </tr>
            </table>
        }
        <p>
            <input type="submit" value="Create"/>
        </p>
    </fieldset>
}
<div>
    @Html.ActionLink("Back to List", "Index")
</div>
