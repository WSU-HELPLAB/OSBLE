@model IEnumerable<OSBLE.Models.Users.Mail>
@using OSBLE.Models
@using OSBLE.Models.Courses

@{
    ViewBag.Title = "Mail";
}
    <p>
        @Html.ActionLink("Compose new message", "Create")&nbsp &nbsp
        @Html.ActionLink("Compose new message to Instructor(s)", "CreateInstructor")&nbsp &nbsp
        @Html.ActionLink("Compose new message to TA(s)", "CreateTA")&nbsp &nbsp
        @Html.ActionLink("Compose new message to Instructor(s) and TA(s)", "CreateInstructorTA")
    </p>

    @if (ViewBag.BoxHeader == "Inbox")
    {
        <h2>Inbox</h2>
        <table>
            <tr>
                <td>@Html.ActionLink("Go to Outbox", "Outbox")</td>
                <td><a href="#" onclick="deleteSelectedInbox();">Delete Selected</a></td>
            </tr>
        </table>
    }
    else
    {
        <h2>Outbox</h2>
        <table>
            <tr>
                <td>@Html.ActionLink("Go to Inbox", "Index") &nbsp</td>
                <td><a href="#" onclick="deleteSelectedOutbox();">Delete Selected</a></td>
            </tr>
        </table>
        
    }
    <br />

<table class="inbox_table">
    <thead>
    @{
        if (ViewBag.BoxHeader == "Inbox")
        {
    
        <tr>
            <th id="checkAll" class="inbox_checkbox_header"><input id="checkAllBox" name="foo" type="checkbox" /></th>
            <th id="0" class="inbox_time_header">@Html.ActionLink("Date:", "Index", new { sortBy = 0 })</th>
            <th id="1" class="inbox_context_header">@Html.ActionLink("Context:", "Index", new { sortBy = 1 })</th>
            <th id="2" class="inbox_from_header">@Html.ActionLink("From:", "Index", new { sortBy = 2 })</th>
            <th id="3" class="inbox_subject_header">@Html.ActionLink("Subject:", "Index", new { sortBy = 3 })</th>
            <th id="4" class="inbox_tools_header"></th>
        </tr>
        }
        else
        {
        <tr>
            <th id="checkAll" class="inbox_checkbox_header"><input id="checkAllBox" type="checkbox" /></th>
            <th id="0" class="inbox_time_header">@Html.ActionLink("Date:", "Outbox", new { sortBy = 0 })</th>
            <th id="1" class="inbox_context_header">@Html.ActionLink("Context:", "Outbox", new { sortBy = 1 })</th>
            <th id="2" class="inbox_from_header">@Html.ActionLink("To:", "Outbox", new { sortBy = 2 })</th>
            <th id="3" class="inbox_subject_header">@Html.ActionLink("Subject:", "Outbox", new { sortBy = 3 })</th>
            <th id="4" class="inbox_tools_header"></th>
        </tr>
        }
    }
    </thead>
    @foreach (var item in Model)
    {
      
        <tr id="mail_item_@(item.ID)" class="@if (!item.Read)
                                             {<text>inbox_unread</text>}">
            <td><input id="@item.ID" class="mailCheckBoxClass" name="deleteInputs" type="checkbox" /></td>
            <td class="inbox_time">
                <small>@item.Posted.ToShortDateString() @item.Posted.ToShortTimeString()</small>
            </td>
            <td class="inbox_context">
                @if (item.Context != null)
                {
                    if (item.Context is Course)
                    {
                        Course c = item.Context as Course;
                        <small>@String.Format("{0} {1}", c.Prefix, c.Number)</small>
                    }
                    else if (item.Context is Community)
                    {
                        Community comm = item.Context as Community;
                        <small>@comm.Nickname</small>
                    }
                }
            </td>
            <td class="inbox_from">
                @if (ViewBag.BoxHeader == "Inbox")
                {
                    <small>@item.FromUserProfile.FirstName @item.FromUserProfile.LastName</small>
                }
                else
                {
                    <small>@item.ToUserProfile.FirstName @item.ToUserProfile.LastName</small>
                }
            </td>
            <td class="inbox_subject">
                @Html.ActionLink(item.Subject, "View", new { id = item.ID })
            </td>
            <td class="inbox_tools">
            @if (ViewBag.BoxHeader == "Inbox")
            {
                <form action="@Url.Action("DeleteFromInbox")"
                style="display: inline;"
                data-ajax="true"
                data-ajax-success="$('#mail_item_@(item.ID)').hide(function(){$(this).remove();})"
                data-ajax-confirm="Are you sure you want to delete this message?"
                method="post">
                <input type="hidden" name="ID" value="@item.ID" />
                @Helpers.DeleteSubmit("Delete This Mail Message")
                </form>
            }
                
            @if (ViewBag.BoxHeader == "Outbox")
            {
                <form action="@Url.Action("DeleteFromOutbox")"
                style="display: inline;"
                data-ajax="true"
                data-ajax-success="$('#mail_item_@(item.ID)').hide(function(){$(this).remove();})"
                data-ajax-confirm="Are you sure you want to delete this message?"
                method="post">
                <input type="hidden" name="ID" value="@item.ID" />
                @Helpers.DeleteSubmit("Delete This Mail Message")
                </form>
            }
            </td>
        </tr>
    }
</table>

<script type="text/javascript">
    var checkBool = true;
    $("#checkAll").change(function () {
        if (checkBool == true) {            
            checkBool = false;
            $('input[class=mailCheckBoxClass]').each(function () {
                $(this).attr('checked', true);
            });
        }
        else {
            checkBool = true;
            $('input[class=mailCheckBoxClass]').each(function () {
                $(this).attr('checked', false);
            });
        }
    });

    function deleteSelectedInbox() {

        var mailIds = new Array();
        var i = 0;
        $('input[class=mailCheckBoxClass]').each(function () {
            if ($(this).attr("checked") == "checked") {
                mailIds[i] = $(this).attr("id");
                i += 1;
            }
        });
        $.ajax({
            type: "POST",
            url: "/Mail/DeleteSelectedInbox",
            data: { deleteIds: mailIds.toString() }
        });
        window.location.reload(true);
    };

    function deleteSelectedOutbox() {

        var mailIds = new Array();
        var i = 0;
        $('input[class=mailCheckBoxClass]').each(function () {
            if ($(this).attr("checked") == "checked") {
                mailIds[i] = $(this).attr("id");
                i += 1;
            }
        });
        $.ajax({
            type: "POST",
            url: "/Mail/DeleteSelectedOutbox",
            data: { deleteIds: mailIds.toString() }
        });
        window.location.reload(true);
    };
</script>