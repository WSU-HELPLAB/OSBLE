@using OSBLE.Models.Courses
@using OSBLEPlus.Logic.Utility
@using OSBLEPlus.Logic.Utility.Lookups
@using OSBLE.Models.Queries
@using OSBLE.Models.Users
@model OSBLEPlus.Logic.DomainObjects.ActivityFeeds.FeedViewModel
@{
    UserProfile currentUser = ViewBag.CurrentUser;
}


<script type="text/javascript" src="@Url.Content("~/Scripts/knockout-2.2.1.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/ActivityFeed.js")"></script>
<script type="text/javascript">
    var vm = new FeedViewModel("@currentUser.FullName", @currentUser.ID);;
    $(document).ready(function () {
        ko.applyBindings(vm);
    });
</script>

<section data-tab="ActivityFeed">
    <div id="activity_new_post">
        @if (ViewBag.ActiveCourse.AbstractRole != null)
        {
            if ((ViewBag.ActiveCourse.AbstractRole.CanGrade == true) || (ViewBag.ActiveCourse.AbstractRole.Anonymized) || ((ViewBag.ActiveCourse.AbstractCourse is Course) && (ViewBag.ActiveCourse.AbstractCourse.AllowDashboardPosts) == true))
            {
                if (ViewBag.Error != null)
                {
                    <h3 class="error">@ViewBag.Error</h3>
                }
                using (Ajax.BeginForm("PostFeedItem", "Feed",
                    new AjaxOptions
                    {
                        HttpMethod = "POST",
                        UpdateTargetId = "dp_posts",
                        OnComplete = "PostFeedItemComplete()"
                    },
                    new { 
                        id = "post-comment-form", 
                        @class = "spinner" 
                    }))
                {
                    <div class="form-group">
                        <textarea id="feed-post-textbox" class="form-control" name="comment" rows="4" placeholder="Enter new feed post here..."></textarea>
                    </div>

                    <input type="submit" id="btn_post_active" class="btn btn-default" name="post_active" value="Post to @Helpers.CourseTag(ViewBag.ActiveCourse.AbstractCourse)" />

                    /*if (ViewBag.IsInstructor)
                    {
                        <input type="submit" id="btn_post_all" class="btn btn-default" name="post_all" value="Post to All Courses I Teach" onclick="return confirm('Post this message to all your taught courses?');" />
                        <label class="checkbox-inline"><input type="checkbox" value="True" name="send_email" /> Email to Class</label>
                    }

                    if (ViewBag.IsLeader)
                    {
                        <label class="checkbox-inline"><input type="checkbox" value="True" name="send_email" /> Email to Community</label>
                    }*/
                }
            }
        }
    </div>

    <div id="filters">
        @using (Html.BeginForm("Index", "Feed", FormMethod.Post))
        {
            <div id="keywordSection" class="form-group">
                <label id="feedSearchIcon" for="feedSearchInput"><span class="glyphicon glyphicon-search"></span></label>
                <input id="feedSearchInput" type="text" class="typeahead form-control" name="keyword" autocomplete="off" value="@Model.Keyword" placeholder="Search by keyword..." />
            </div>
        }

        @using (Ajax.BeginForm("ApplyFeedFilter", "Feed", new AjaxOptions
        {
            HttpMethod = "Get",
            UpdateTargetId = "dp_posts"
        }))
        {
            <div id="filter-type" class="form-group">
                @foreach (EventType e in ActivityFeedQuery.GetNecessaryEvents())
                {
                    <div class="checkbox filter-type-option">
                        <label>
                            <input type="checkbox" id="event_@e.ToString()" name="event_@e.ToString()" />
                            @Helpers.GetOptionNameOfEventType(e)
                        </label>
                    </div>
                }
                @* This allows the parent div to properly "contain" all the checkboxes *@
                <div style="clear: both"></div>
            </div>
            @*<article>
                    <h2>Filter by Error Type:</h2>
                    <select name="error-type">
                        <option value="-1">No Filter</option>
                        @foreach (ErrorType error in Model.ErrorTypes)
                        {
                            string selectedText = "";
                            if (error.Name.CompareTo(Model.SelectedErrorType.Name) == 0)
                            {
                                selectedText = @"selected=""selected""";
                            }
                            <option @Html.Raw(selectedText) value="@error.Id">@error.Name</option>
                        }
                    </select>
                </article>
                <article>
                    <h2>Filter by Course</h2>
                    <select name="course-filter">
                        <option value="-1">No Filter</option>
                        @foreach (Course course in Model.Courses)
                        {
                            string selectedText = "";
                            if (course.ID.CompareTo(Model.SelectedCourseId) == 0)
                            {
                                selectedText = @"selected=""selected""";
                            }
                            <option @Html.Raw(selectedText) value="@course.ID">@course.Name</option>
                        }
                    </select>
                </article>
                <article>
                    <h2>Filter by User Type</h2>
                    <select name="user-type-filter">
                        <option value="-1">No Filter</option>
                        @foreach (CourseRole.CourseRoles role in Model.CourseRoles)
                        {
                            string selectedText = "";
                            int roleValue = (int)role;
                            string roleName = Enum.GetName(typeof(CourseRole.CourseRoles), roleValue);
                            if (role == Model.SelectedCourseRole)
                            {
                                selectedText = @"selected=""selected""";
                            }
                            <option @Html.Raw(selectedText) value="@roleValue">@roleName</option>
                        }
                    </select>
                </article>*@
        }
    </div>

    <div id="dp_posts" class="panel-group">
        @Html.Partial("Feed/_Feed", Model)
    </div>

</section>

@*@section Scripts
{
    <script type="text/javascript" src="~/Scripts/Typeahead/typeahead-0.10.4.js"></script>
    <script type="text/javascript" src="~/Scripts/Typeahead/osbide-posts.js"></script>
    <script type="text/javascript" src="~/Scripts/Typeahead/jquery.textcomplete.js"></script>
    <script type="text/javascript" src="~/Scripts/Typeahead/jquery.overlay.js"></script>
}*@

